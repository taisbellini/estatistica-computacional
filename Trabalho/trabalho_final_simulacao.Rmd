---
title: "trabalho_final_simulacao"
date: "10/5/2020"
output: html_document
---

# Funcoes auxiliares

## Funcao simulacao

Funcao para rodar n vezes o MCMC (arquivo master) e guardar os resultados.

```{r}

# Recebe o numero de vezes que ira rodar o MCMC, o numero de iteracoes que o MCMC tera, o parametro p e a proposta a ser usada.
f_sim = function(n, nr, p, proposal, text, key_real, reference_bigrams, reference_freq){
  
  key_accuracy = numeric(n)
  text_accuracy = numeric(n)
  acceptance_rate = numeric(n)
  f_max = numeric(n)
  
  key0 = alpha
  encoded = encode_subs(key_real, text)
  text_list = strsplit(text, "")[[1]]
  
  for (i in 1:n){
    result = mcmc(encoded, key0, reference_bigrams, reference_freq, proposal = proposal, nr = nr, p = p)
    key_accuracy[i] = accuracy(key_real, result$key_max)
    decoded = decode_subs(result$key_max, encoded)
    text_accuracy[i] = accuracy(text_list, decoded)
    acceptance_rate[i] = result$accept/nr
    f_max[i] = result$f_max
  }
  
  return(
    list(
      "key_accuracy" = key_accuracy,
      "text_accuracy" = text_accuracy,
      "acceptance_rate" = acceptance_rate,
      "f_max" = f_max
    )
  )
}

```


Rodando f_sim uma vez:

Prepara o texto para ser usado como encoded.
```{r}
enc_txt = get_text('pride_and_prejudice.txt')
ENC_TXT = clean_text(enc_txt)
set.seed(205)
line = sample(1:length(ENC_TXT), 1)
enc_string = ENC_TXT[line]
enc_string
```


```{r}
p=1.5
n = 5
nr = 10000
proposal = 2
set.seed(205650)
key_real = sample(alpha)
text = enc_string

fsim_result = f_sim(n, nr, p, proposal, text, key_real, REFERENCE_FREQUENCY$bigrams, REFERENCE_FREQUENCY$Freq)
fsim_result
```


# Simulacao 

## Ajustando os parametros

Vamos variar os seguintes parametros para encontrar a combinacao otima: 

#### Proposta 
*Proposta 1*
Seleciona duas posicoes da chave e troca elas de lugar.

*Proposta 2*
Executa a proposta 1 duas vezes.

*Proposta 3*
Escolhe um n que assume 1, 2 ou 3 aleatoriamente. Executa a proposta 1 n vezes.

#### Parametro p 

Parametro no qual a razao entre a funcao p da chave anterior e da atual sera elavado. 
p assume: 0.5, 1, 1.5 e 2


#### Iteracoes

Varia o numero de iteracoes do Algoritmo MCMC: 1000, 10000, 50000

## Simulacoes

### Proposta

Vamos testar as 3 propostas rodando o mcmc 20 vezes com cada uma e 10000 iteracoes.

```{r}
resultados_propostas = matrix(nrow = 3, ncol = 7)
resultados_propostas[,1] = c(1, 2, 3)
colnames(resultados_propostas) = c('Proposta', 'Media Acc Key', 'Sd Acc Key', 'Media Acc Text', 'Sd Acc Text', 'Media Acceptance Rate', 'Sd Acceptance Rate')

set.seed(205650)
for (i in 1:nrow(resultados_propostas)){
  proposal = resultados_propostas[i,1]
  p = 1
  nr = 10000
  n = 20
  result = f_sim(n, nr, p, proposal, text, key_real, REFERENCE_FREQUENCY$bigrams, REFERENCE_FREQUENCY$Freq)
  
  resultados_propostas[i,2] = mean(result$key_accuracy)
  resultados_propostas[i,3] = sd(result$key_accuracy)
  resultados_propostas[i,4] = mean(result$text_accuracy)
  resultados_propostas[i,5] = sd(result$text_accuracy)
  resultados_propostas[i,6] = mean(result$acceptance_rate)
  resultados_propostas[i,7] = sd(result$acceptance_rate)
  
}

resultados_propostas

```


 Proposta Media Acc Key Sd Acc Key Media Acc Text Sd Acc Text Media Acceptance Rate Sd Acceptance Rate
[1,]        1    0.05000000 0.04378161          0.090   0.1145038              0.985205        0.003350173
[2,]        2    0.09814815 0.08085440          0.185   0.1666579              0.976880        0.006654607
[3,]        3    0.08148148 0.05837548          0.140   0.1182722              0.976990        0.009037518

A proposta escolhida foi a 2. Observe que a taxa de aceitacao esta muito alta. Vamos ajustar o parametro p para obtermos uma taxa mais adequada.

### Validando o parametro p


```{r}
resultados_p = matrix(nrow = 3, ncol = 7)
resultados_p[,1] = c(1.5, 1, 0.5)
colnames(resultados_p) = c('p', 'Media Acc Key', 'Sd Acc Key', 'Media Acc Text', 'Sd Acc Text', 'Media Acceptance Rate', 'Sd Acceptance Rate')

set.seed(205650)
for (i in 1:nrow(resultados_p)){
  proposal = 2
  p = resultados_p[i,1]
  nr = 10000
  n = 20
  result = f_sim(n, nr, p, proposal, text, key_real, REFERENCE_FREQUENCY$bigrams, REFERENCE_FREQUENCY$Freq)
  
  resultados_p[i,2] = mean(result$key_accuracy)
  resultados_p[i,3] = sd(result$key_accuracy)
  resultados_p[i,4] = mean(result$text_accuracy)
  resultados_p[i,5] = sd(result$text_accuracy)
  resultados_p[i,6] = mean(result$acceptance_rate)
  resultados_p[i,7] = sd(result$acceptance_rate)
  
}

resultados_p
```


      p Media Acc Key Sd Acc Key Media Acc Text Sd Acc Text Media Acceptance Rate Sd Acceptance Rate
[1,] 50     0.1074074 0.07397654      0.1866667   0.1683772             0.3630875          0.1177849
[2,] 20            NA         NA             NA          NA                    NA                 NA
[3,]  1            NA         NA             NA          NA                    NA                 NA

Estrutura para salvar resultados: Media e desvio de cada medida de resultado
```{r}
param_tuning = expand.grid(1:3, c(0.05, 1, 10, 50), c(1000, 10000, 50000), 1:1, 1:1, 1:1, 1:1, 1:1, 1:1)
colnames(param_tuning) = c('Proposta', 'p', 'Iteracoes', 'Media Acc Key', 'Sd Acc Key', 'Media Acc Text', 'Sd Acc Text', 'Media Acceptance Rate', 'Sd Acceptance Rate')
```



```{r}
set.seed(205650)
n = 100
key_real = sample(alpha)
enc_string = strsplit(enc_string, "")[[1]]
text = enc_string[1:30]
text = vector_to_string(text)

for (i in 20:36){
  proposal = param_tuning[i,1]
  p = param_tuning[i,2]
  nr = param_tuning[i,3]
  result = f_sim(n, nr, p, proposal, text, key_real, reference$bigrams, reference$Freq)
  
  param_tuning[i,4] = mean(result$key_accuracy)
  param_tuning[i,5] = sd(result$key_accuracy)
  param_tuning[i,6] = mean(result$text_accuracy)
  param_tuning[i,7] = sd(result$text_accuracy)
  param_tuning[i,8] = mean(result$acceptance_rate)
  param_tuning[i,9] = sd(result$acceptance_rate)
  
}

```

