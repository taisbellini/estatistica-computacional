---
title: "trabalho_final_simulacao"
date: "10/5/2020"
output: html_document
---

# Funcoes auxiliares

## Funcao simulacao

Funcao para rodar n vezes o MCMC (arquivo master) e guardar os resultados.

```{r}

# Recebe o numero de vezes que ira rodar o MCMC, o numero de iteracoes que o MCMC tera, o parametro p e a proposta a ser usada.
f_sim = function(n, nr, p, proposal, text, key_real, reference_bigrams, reference_freq){
  
  key_accuracy = numeric(n)
  text_accuracy = numeric(n)
  acceptance_rate = numeric(n)
  f_max = numeric(n)
  
  key0 = alpha
  encoded = encode_subs(key_real, text)
  text_list = strsplit(text, "")[[1]]
  
  for (i in 1:n){
    result = mcmc(encoded, key0, reference_bigrams, reference_freq, proposal = proposal, nr = nr, p = p)
    key_accuracy[i] = accuracy(key_real, result$key_max)
    decoded = decode_subs(result$key_max, encoded)
    text_accuracy[i] = accuracy(text_list, decoded)
    acceptance_rate[i] = result$accept/nr
    f_max[i] = result$f_max
  }
  
  return(
    list(
      "key_accuracy" = key_accuracy,
      "text_accuracy" = text_accuracy,
      "acceptance_rate" = acceptance_rate,
      "f_max" = f_max
    )
  )
}

```


Rodando f_sim uma vez:

Prepara o texto para ser usado como encoded.
```{r}
enc_txt = get_text('pride_and_prejudice.txt')
ENC_TXT = clean_text(enc_txt)
set.seed(205)
line = sample(1:length(ENC_TXT), 1)
enc_string = ENC_TXT[line]
enc_string
```


```{r}
p=1.5
n = 5
nr = 10000
proposal = 2
set.seed(205650)
key_real = sample(alpha)
text = enc_string

fsim_result = f_sim(n, nr, p, proposal, text, key_real, REFERENCE_FREQUENCY$bigrams, REFERENCE_FREQUENCY$Freq)
fsim_result
```


# Simulacao 

## Ajustando os parametros

Vamos variar os seguintes parametros para encontrar a combinacao otima: 

#### Proposta 
*Proposta 1*
Seleciona duas posicoes da chave e troca elas de lugar.

*Proposta 2*
Executa a proposta 1 duas vezes.

*Proposta 3*
Escolhe um n que assume 1, 2 ou 3 aleatoriamente. Executa a proposta 1 n vezes.

#### Parametro p 

Parametro no qual a razao entre a funcao p da chave anterior e da atual sera elavado. 
p assume: 0.5, 1, 1.5 e 2


#### Iteracoes

Varia o numero de iteracoes do Algoritmo MCMC: 1000, 10000, 50000

## Simulacoes

### Proposta

Vamos testar as 3 propostas rodando o mcmc 20 vezes com cada uma e 10000 iteracoes.

```{r}
resultados_propostas = matrix(nrow = 3, ncol = 7)
resultados_propostas[,1] = c(1, 2, 3)
colnames(resultados_propostas) = c('Proposta', 'Media Acc Key', 'Sd Acc Key', 'Media Acc Text', 'Sd Acc Text', 'Media Acceptance Rate', 'Sd Acceptance Rate')

set.seed(205650)
for (i in 1:nrow(resultados_propostas)){
  proposal = resultados_propostas[i,1]
  p = 1
  nr = 10000
  n = 20
  result = f_sim(n, nr, p, proposal, text, key_real, REFERENCE_FREQUENCY$bigrams, REFERENCE_FREQUENCY$Freq)
  
  resultados_propostas[i,2] = mean(result$key_accuracy)
  resultados_propostas[i,3] = sd(result$key_accuracy)
  resultados_propostas[i,4] = mean(result$text_accuracy)
  resultados_propostas[i,5] = sd(result$text_accuracy)
  resultados_propostas[i,6] = mean(result$acceptance_rate)
  resultados_propostas[i,7] = sd(result$acceptance_rate)
  
}

resultados_propostas

```


     Proposta Media Acc Key Sd Acc Key Media Acc Text Sd Acc Text Media Acceptance Rate Sd Acceptance Rate
[1,]        1     0.2425926 0.09648729      0.5054688   0.1170668              0.339325        0.007961875
[2,]        2     0.2500000 0.07959449      0.5187500   0.1430798              0.142500        0.006233863
[3,]        3     0.2277778 0.12270564      0.4851563   0.1724702              0.182095        0.006491734

A proposta escolhida foi a 2. Observe que a taxa de aceitacao esta muito alta. Vamos ajustar o parametro p para obtermos uma taxa mais adequada.

### Validando o parametro p


```{r}
resultados_p = matrix(nrow = 3, ncol = 7)
resultados_p[,1] = c(1.5, 1, 0.5)
colnames(resultados_p) = c('p', 'Media Acc Key', 'Sd Acc Key', 'Media Acc Text', 'Sd Acc Text', 'Media Acceptance Rate', 'Sd Acceptance Rate')

set.seed(205650)
for (i in 1:nrow(resultados_p)){
  proposal = 2
  p = resultados_p[i,1]
  nr = 10000
  n = 20
  result = f_sim(n, nr, p, proposal, text, key_real, REFERENCE_FREQUENCY$bigrams, REFERENCE_FREQUENCY$Freq)
  
  resultados_p[i,2] = mean(result$key_accuracy)
  resultados_p[i,3] = sd(result$key_accuracy)
  resultados_p[i,4] = mean(result$text_accuracy)
  resultados_p[i,5] = sd(result$text_accuracy)
  resultados_p[i,6] = mean(result$acceptance_rate)
  resultados_p[i,7] = sd(result$acceptance_rate)
  
}

resultados_p
```


       p Media Acc Key Sd Acc Key Media Acc Text Sd Acc Text Media Acceptance Rate Sd Acceptance Rate
[1,] 1.5     0.2481481 0.09392799      0.5625000   0.1519135              0.084470        0.005442822
[2,] 1.0     0.2592593 0.08665150      0.5679688   0.1490336              0.143475        0.006542724
[3,] 0.5     0.1629630 0.08359824      0.3640625   0.1406798              0.306610        0.006548194


### Validando o numero de iteracoes

```{r}
resultados_it = matrix(nrow = 3, ncol = 7)
resultados_it[,1] = c(5000, 10000, 50000)
colnames(resultados_it) = c('it', 'Media Acc Key', 'Sd Acc Key', 'Media Acc Text', 'Sd Acc Text', 'Media Acceptance Rate', 'Sd Acceptance Rate')

set.seed(2056501)
for (i in 1:nrow(resultados_it)){
  proposal = 2
  nr = resultados_it[i,1]
  p = 0.5
  n = 20
  result = f_sim(n, nr, p, proposal, text, key_real, REFERENCE_FREQUENCY$bigrams, REFERENCE_FREQUENCY$Freq)
  
  resultados_it[i,2] = mean(result$key_accuracy)
  resultados_it[i,3] = sd(result$key_accuracy)
  resultados_it[i,4] = mean(result$text_accuracy)
  resultados_it[i,5] = sd(result$text_accuracy)
  resultados_it[i,6] = mean(result$acceptance_rate)
  resultados_it[i,7] = sd(result$acceptance_rate)
  
}

resultados_it
```

        it Media Acc Key Sd Acc Key Media Acc Text Sd Acc Text Media Acceptance Rate Sd Acceptance Rate
[1,]  5000     0.2000000 0.08006928      0.4617188  0.15396979              0.146650        0.007505752
[2,] 10000     0.2518519 0.09354288      0.5375000  0.14913057              0.142320        0.004953956
[3,] 50000     0.2685185 0.06112440      0.5906250  0.09161494              0.141618        0.003228426


Estrutura para salvar resultados: Media e desvio de cada medida de resultado
```{r}
param_tuning = expand.grid(1:3, c(0.8, 1, 1.5), c(10000, 50000, 60000), 1:1, 1:1, 1:1, 1:1, 1:1, 1:1)
colnames(param_tuning) = c('Proposta', 'p', 'Iteracoes', 'Media Acc Key', 'Sd Acc Key', 'Media Acc Text', 'Sd Acc Text', 'Media Acceptance Rate', 'Sd Acceptance Rate')
```



```{r}
set.seed(205650)
enc_txt = get_text('pride_and_prejudice.txt')
ENC_TXT = clean_text(enc_txt)
set.seed(205)
line = sample(1:length(ENC_TXT), 1)
enc_string = ENC_TXT[line]
enc_string = strsplit(enc_string, "")[[1]]
text = enc_string[1:30]
text = vector_to_string(text)

n = 100
key_real = sample(alpha)

for (i in 1:36){
  proposal = param_tuning[i,1]
  p = param_tuning[i,2]
  nr = param_tuning[i,3]
  result = f_sim(n, nr, p, proposal, text, key_real, REFERENCE_FREQUENCY$bigrams, REFERENCE_FREQUENCY$Freq)
  
  param_tuning[i,4] = mean(result$key_accuracy)
  param_tuning[i,5] = sd(result$key_accuracy)
  param_tuning[i,6] = mean(result$text_accuracy)
  param_tuning[i,7] = sd(result$text_accuracy)
  param_tuning[i,8] = mean(result$acceptance_rate)
  param_tuning[i,9] = sd(result$acceptance_rate)
  
}

```

